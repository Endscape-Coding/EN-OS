# ======================
# EN-OS - GRUB2 Main Configuration
# Loads Midnight Ocean gfxmenu Theme
# ======================

### Load essential modules for graphics and file systems
insmod all_video
insmod gfxterm
insmod png
insmod font
insmod part_gpt
insmod part_msdos
insmod ext2
insmod fat

### Set graphical mode
if loadfont "${prefix}/fonts/unicode.pf2"; then
  set gfxmode=auto
  terminal_output gfxterm
fi

### Load gfxmenu Theme
insmod gfxmenu
load_theme "${prefix}/themes/midnight-ocean/theme.txt"

### Platform detection
if [ "${grub_platform}" = 'efi' ]; then
  set bootmode="UEFI"
  set arch_label="x64"
else
  set bootmode="BIOS"
  set arch_label="%ARCH%"
fi

### Main menu configuration
set default="en-os-standard"
set timeout=5
set timeout_style=menu

### Menu entries
menuentry " EN-OS Live Environment " --class os --id en-os-standard {
  set gfxpayload=keep
  linux /%INSTALL_DIR%/boot/%ARCH%/vmlinuz-linux archisobasedir=%INSTALL_DIR% quiet splash
  initrd /%INSTALL_DIR%/boot/%ARCH%/initramfs-linux.img
}

menuentry " Safe Graphics Mode " --class recovery {
  set gfxpayload=keep
  linux /%INSTALL_DIR%/boot/%ARCH%/vmlinuz-linux archisobasedir=%INSTALL_DIR% nomodeset
  initrd /%INSTALL_DIR%/boot/%ARCH%/initramfs-linux.img
}

submenu " Advanced Options " --class advanced {
  menuentry " Debug Mode " --class debug {
    set gfxpayload=keep
    linux /%INSTALL_DIR%/boot/%ARCH%/vmlinuz-linux archisobasedir=%INSTALL_DIR% debug
    initrd /%INSTALL_DIR%/boot/%ARCH%/initramfs-linux.img
  }

  menuentry " Memory Test (Memtest86+) " --class memtest {
    # Универсальная проверка для Memtest
    if [ "${grub_platform}" == 'efi' -a -f '/boot/memtest86+/memtest.efi' ]; then
      linux /boot/memtest86+/memtest.efi
    elif [ "${grub_platform}" == 'pc' -a -f '/boot/memtest86+/memtest' ]; then
      linux /boot/memtest86+/memtest
    else
      echo "Memtest86+ not found"
      sleep 5
    fi
  }
}

### UEFI Specific Entries
if [ "${grub_platform}" == 'efi' ]; then
  menuentry " UEFI Firmware Settings " --class efi --id uefi-firmware {
    fwsetup
  }
fi

### System Controls
menuentry " System Shutdown " --class shutdown {
  halt
}

menuentry " System Restart " --class reboot {
  reboot
}

### Final message (optional)
echo "EN-OS Bootloader initialized successfully."
